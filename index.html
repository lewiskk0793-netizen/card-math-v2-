<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <!-- ç›¸å®¹èˆŠç‰ˆ iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!-- æ–°æ¨™æº–ï¼ˆæ¶ˆé™¤è­¦å‘Šï¼‰ -->
  <meta name="mobile-web-app-capable" content="yes" />
  <title>å…­å¼µç®—è¡“ - å–®äººç‰ˆ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: #f0f5ff;
      margin: 0;
      padding: 0;
      color: #333;
      touch-action: manipulation;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-top: 0;
      font-size: 24px;
    }

    /* è¨ˆåˆ†èˆ‡è¨ˆæ™‚ */
    .score-time {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: bold;
      align-items: center;
    }
    .timer-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    .timer-fill {
      height: 100%;
      background: #0984e3;
      width: 100%;
      transition: width 0.1s linear;
    }

    /* ç›®æ¨™å¡ */
    .target-row {
      display: flex;
      justify-content: center;
      margin: 12px 0;
    }
    .target-card {
      width: 60px;
      height: 76px;
      border: 2px solid #d63031;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      background: #ffeaa7;
    }

    /* æ‰‹ç‰Œå€ - ç¢ºä¿ 5 å¼µå¡æ°¸é åœ¨åŒä¸€è¡Œ */
    .hand-area {
      min-height: 90px;
      margin: 12px 0;
      padding: 12px 8px;
      background: #fafafa;
      border-radius: 8px;
      display: flex;
      flex-wrap: nowrap; /* è¦æ­¢æ›è¡Œ */
      gap: 6px;
      justify-content: center;
      align-items: center;
      /* å®Œå…¨ç¦æ­¢æ°´å¹³æ»¾å‹• */
    }

    /* å¡ç‰‡ - è‡ªå‹•ç¸®å°ä»¥é©æ‡‰æ‰€æœ‰è¢å¹• */
    .card {
      /* ä½¿ç”¨ flex å±¬æ€§è®“å¡ç‰‡è‡ªå‹•èª¿æ•´ */
      flex: 0 0 calc(20% - 4.8px); /* 5å¼µå¡ = 20% each, æ¸›å» gap */
      min-width: 40px; /* æœ€å°å¯¬åº¦ */
      height: 70px;
      border: 2px solid #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      background: white;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    /* å°è¢å¹•å„ªåŒ– */
    @media (max-width: 400px) {
      .card {
        min-width: 36px;
        height: 65px;
        font-size: 12px;
        gap: 4px;
      }
      
      .hand-area {
        padding: 12px 6px;
        gap: 4px;
      }
    }

    /* å¤§è¢å¹•ä¿æŒç¾è§€ */
    @media (min-width: 600px) {
      .card {
        width: 56px;
        height: 76px;
        font-size: 16px;
        flex: none; /* å¤§è¢å¹•ä½¿ç”¨å›ºå®šå¯¬åº¦ */
      }
      
      .hand-area {
        gap: 10px;
        padding: 12px;
      }
    }

    .card.selected-first {
      border-color: #0984e3;
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(9, 132, 227, 0.6);
    }

    .card.new-glow {
      animation: newCardGlow 1.2s ease-out;
    }

    @keyframes newCardGlow {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      50% { box-shadow: 0 0 16px 4px rgba(40, 167, 69, 0.8); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    /* é‹ç®—é¸å–® */
    .operator-menu {
      display: none;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .op-btn {
      width: 48px;
      height: 48px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      background: #0984e3;
      color: white;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .cancel-btn {
      padding: 8px 16px;
      background: #ff7675;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      -webkit-tap-highlight-color: transparent;
    }

    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 16px 0;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #0984e3;
      color: white;
      font-weight: bold;
      -webkit-tap-highlight-color: transparent;
    }
    #hintBtn { background: #00b894; }
    #nextBtn { background: #fdcb6e; color: #2d3436; }
    #resetBtn { background: #a29bfe; }
    #helpBtn { background: #6c5ce7; }

    .message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
    }
    .success { background: #d5f4e6; color: #00a86b; }
    .error { background: #ffdddd; color: #d63031; }
    .info { background: #e3f2fd; color: #0984e3; }

    /* ç©æ³•èªªæ˜ Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      overflow: auto;
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin-left: 16px;
      margin-right: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .instructions h2 {
      margin-top: 0;
      color: #2c3e50;
    }
    .instructions ul {
      padding-left: 20px;
      line-height: 1.6;
    }
    
    /* Start! è¦†è“‹å±¤ */
    .start-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .start-overlay.active {
      pointer-events: auto;
    }

    .start-overlay-content {
      position: absolute;
      text-align: center;
      /* ä½ç½®å°‡ç”± JavaScript å‹•æ…‹è¨­å®š */
    }

    .start-overlay.blur .container {
      filter: blur(8px);
      transition: filter 0.5s ease-in-out;
    }

    .start-game-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 16px 48px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      z-index: 1001;
    }

    .start-game-btn:hover, .start-game-btn:active {
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(255, 107, 107, 0.7);
    }
    
    /* æˆåŠŸ/å¤±æ•—å½ˆå‡ºç•«é¢ - å®Œç¾ç½®ä¸­ */
    #successModal, #failureModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 2000;
      /* ä½¿ç”¨ flexbox ç½®ä¸­ */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #successModal .modal-content,
    #failureModal .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      position: relative;
    }

    /* æˆåŠŸç•«é¢æ¨£å¼ */
    #successModal .modal-content {
      background: #d5f4e6;
      border: 3px solid #00a86b;
    }

    #successTimeMessage {
      color: #00a86b;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 20px;
    }

    #successMessage {
      font-size: 16px;
      margin: 15px 0;
      color: #006400;
    }

    /* å¤±æ•—ç•«é¢æ¨£å¼ */
    #failureModal .modal-content {
      background: #ffebee;
      border: 3px solid #d63031;
    }

    #failureModal h2 {
      color: #d63031;
      margin-top: 0;
      margin-bottom: 20px;
    }

    #failureMessage {
      font-size: 18px;
      margin: 20px 0;
      color: #8B0000;
    }

    /* å‹•ä½œæŒ‰éˆ•å®¹å™¨ */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 25px;
      width: 100%;
    }

    /* å‹•ä½œæŒ‰éˆ•é€šç”¨æ¨£å¼ */
    .action-btn {
      flex: 1;
      padding: 14px 8px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      min-height: 70px;
    }

    .action-btn:hover, .action-btn:active {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* æŒ‰éˆ•åœ–ç¤º */
    .btn-icon {
      font-size: 24px;
      margin-bottom: 6px;
      display: block;
    }

    /* é‡æ–°é–‹å§‹æŒ‰éˆ• */
    .restart-btn {
      background: #6c5ce7;
      color: white;
    }

    .restart-btn:hover, .restart-btn:active {
      background: #5a4fcf;
    }

    /* ç¹¼çºŒæŒ‘æˆ°æŒ‰éˆ• */
    .continue-btn {
      background: #00a86b;
      color: white;
    }

    #failureModal .continue-btn {
      background: #d63031;
    }

    #failureModal .continue-btn:hover, #failureModal .continue-btn:active {
      background: #c02929;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å…­å¼µç®—è¡“ - å–®äººç‰ˆ</h1>
    
    <!-- è¨ˆåˆ†èˆ‡è¨ˆæ™‚ -->
    <div class="score-time">
      <div>ğŸ† åˆ†æ•¸: <span id="score">0</span></div>
      <div>â±ï¸ æ™‚é–“: <span id="timeLeft">60</span>s</div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>

    <div class="target-row">
      <div class="target-card" id="targetCard">?</div>
    </div>
    <div class="hand-area" id="handArea"></div>
    
    <div class="operator-menu" id="operatorMenu">
      <button class="op-btn" onclick="selectOperator('+')">+</button>
      <button class="op-btn" onclick="selectOperator('âˆ’')">âˆ’</button>
      <button class="op-btn" onclick="selectOperator('Ã—')">Ã—</button>
      <button class="op-btn" onclick="selectOperator('Ã·')">Ã·</button>
      <button class="cancel-btn" onclick="cancelSelection()">å–æ¶ˆ</button>
    </div>

    <div class="buttons">
      <button id="hintBtn" onclick="showHint()">æç¤º</button>
      <button id="nextBtn" onclick="newGame()">æ›ä¸€é¡Œ</button>
      <button id="resetBtn" onclick="resetHand()">é‡ä¾†</button>
      <button id="helpBtn" onclick="openInstructions()">ç©æ³•èªªæ˜</button>
    </div>
    <div id="message" class="message info">ğŸ¯ é»æ“Š "Start!" é–‹å§‹éŠæˆ²</div>
  </div>

  <!-- Start! è¦†è“‹å±¤ï¼ˆæ‰‹ç‰Œå€åŸŸï¼‰-->
  <div class="start-overlay blur" id="startOverlay">
    <div class="start-overlay-content">
      <button class="start-game-btn" onclick="startGame()">Start!</button>
    </div>
  </div>

  <!-- ç©æ³•èªªæ˜ Modal -->
  <div id="instructionsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInstructions()">&times;</span>
      <div class="instructions">
        <h2>ğŸ® ç©æ³•èªªæ˜</h2>
        <ul>
          <li><strong>ç›®æ¨™</strong>ï¼šåœ¨ 60 ç§’å…§ç”¨ 5 å¼µç‰Œç®—å‡ºç›®æ¨™å€¼</li>
          <li><strong>æ“ä½œ</strong>ï¼š
            <br>1. é»æ“Šç¬¬ä¸€å¼µå¡
            <br>2. é¸æ“‡é‹ç®—ç¬¦
            <br>3. é»æ“Šç¬¬äºŒå¼µå¡ â†’ è‡ªå‹•è¨ˆç®—
          </li>
          <li><strong>è¦å‰‡</strong>ï¼š
            <br>â€¢ ä¸èƒ½ç”¢ç”Ÿè² æ•¸
            <br>â€¢ é™¤æ³•å¿…é ˆæ•´é™¤ï¼ˆç„¡é¤˜æ•¸ï¼‰
            <br>â€¢ ä¸èƒ½é™¤ä»¥é›¶
            <br>â€¢ <strong>ä¸èƒ½å°‡å…©å¼µç›¸åŒæ•¸å€¼çš„å¡ç‰Œç›¸æ¸›</strong>
          </li>
          <li><strong>è¨ˆåˆ†</strong>ï¼šæˆåŠŸ +100 åˆ† + å‰©é¤˜æ™‚é–“ Ã— 10 åˆ†</li>
        </ul>
        <p style="text-align:center; margin-top:16px;">
          <button onclick="closeInstructions()" style="padding:8px 16px; background:#0984e3; color:white; border:none; border-radius:6px;">
            é–‹å§‹éŠæˆ²ï¼
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸå½ˆå‡ºç•«é¢ -->
  <div id="successModal">
    <div class="modal-content">
      <h2 id="successTimeMessage">ğŸ‰ ä½ èŠ±äº† X ç§’å®Œæˆï¼</h2>
      <p id="successMessage"></p>
      <div class="action-buttons">
        <button class="action-btn restart-btn" onclick="restartGame()">
          <span class="btn-icon">ğŸ”„</span>
          <span class="btn-text">é‡æ–°é–‹å§‹</span>
        </button>
        <button class="action-btn continue-btn" onclick="continueChallenge()">
          <span class="btn-icon">âš¡</span>
          <span class="btn-text">ç¹¼çºŒæŒ‘æˆ°</span>
        </button>
      </div>
    </div>
  </div>

  <!-- å¤±æ•—å½ˆå‡ºç•«é¢ -->
  <div id="failureModal">
    <div class="modal-content">
      <h2>ğŸ’ª å†è©¦ä¸€æ¬¡ï¼</h2>
      <p id="failureMessage"></p>
      <div class="action-buttons">
        <button class="action-btn restart-btn" onclick="restartGame()">
          <span class="btn-icon">ğŸ”„</span>
          <span class="btn-text">é‡æ–°é–‹å§‹</span>
        </button>
        <button class="action-btn continue-btn" onclick="continueChallenge()">
          <span class="btn-icon">âš¡</span>
          <span class="btn-text">ç¹¼çºŒæŒ‘æˆ°</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // === éŠæˆ²ç‹€æ…‹ ===
    const VALUE_TO_RANK = {1:'A',2:'2',3:'3',4:'4',5:'5',6:'6',7:'7',8:'8',9:'9',10:'10',11:'J',12:'Q',13:'K'};
    const SUITS = ['â™ ','â™¥','â™¦','â™£'];

    let currentTarget = null;
    let originalHand = [];
    let selectedCard1 = null;
    let selectedOperator = null;
    let score = 0;
    let combo = 0;
    let timeLeft = 60;
    let timer = null;
    let isGameActive = false;
    let currentStep = 0;

    // ğŸ”¥ æ–°å¢ï¼šå„²å­˜ç•¶å‰éŠæˆ²çš„å®Œæ•´ç‹€æ…‹
    let currentGameSnapshot = null;

    // === æ™ºèƒ½é¡Œåº«ç³»çµ±ï¼ˆç„¡é™ä¸é‡è¤‡ + å¤§æ•¸å­—å„ªåŒ–ï¼‰===
    let lastUsedPattern = -1;
    let generatedPuzzles = new Set();

    // è§£æ³•æ¨¡å¼åˆ†é¡ï¼ˆ6 ç¨®å®Œå…¨ä¸åŒè§£æ³•ï¼‰
    const SOLUTION_PATTERNS = [
      // æ¨¡å¼ 1: å…¨åŠ æ³•ï¼ˆå°æ•¸å­—ç‚ºä¸»ï¼‰
      {
        name: 'all_add_small',
        generate: () => {
          const a = Math.floor(Math.random() * 4) + 2; // 2-5
          const b = Math.floor(Math.random() * 3) + 1; // 1-3
          const c = Math.floor(Math.random() * 3) + 1; // 1-3
          const d = 1;
          const e = 1;
          const ops = [a, b, c, d, e].sort(() => Math.random() - 0.5);
          const target = a + b + c + d + e;
          return { ops, target };
        }
      },
      
      // æ¨¡å¼ 2: ä¹˜æ³•å„ªå…ˆï¼ˆæ··åˆå¤§å°æ•¸å­—ï¼‰- ğŸ”¥ å°æ•¸å­—æ”¹ç‚º 1-7
      {
        name: 'multiply_mixed',
        generate: () => {
          const a = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const b = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const c = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const d = 1;
          const e = 1;
          const product = a * b;
          const target = product + c - d - e;
          // ç¢ºä¿ç›®æ¨™å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
          if (target < 3 || target > 13) {
            throw new Error('Invalid target');
          }
          const ops = [a, b, c, d, e].sort(() => Math.random() - 0.5);
          return { ops, target };
        }
      },
      
      // æ¨¡å¼ 3: é™¤æ³•å„ªå…ˆï¼ˆç¢ºä¿æ•´é™¤ï¼‰- ğŸ”¥ å°æ•¸å­—æ”¹ç‚º 1-7
      {
        name: 'divide_exact',
        generate: () => {
          const divisor = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const quotient = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const dividend = divisor * quotient;
          // ç¢ºä¿è¢«é™¤æ•¸ä¸è¶…é 13
          if (dividend > 13) {
            throw new Error('Invalid dividend');
          }
          const c = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const d = 1;
          const e = 1;
          const target = quotient + c - d - e;
          // ç¢ºä¿ç›®æ¨™å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
          if (target < 3 || target > 13) {
            throw new Error('Invalid target');
          }
          const ops = [dividend, divisor, c, d, e].sort(() => Math.random() - 0.5);
          return { ops, target };
        }
      },
      
      // æ¨¡å¼ 4: å¤§æ•¸å­—æŒ‘æˆ°ï¼ˆ5 å¼µå¤§æ•¸å­—ï¼‰
      {
        name: 'big_numbers_challenge',
        generate: () => {
          // 5 å¼µå¤§æ•¸å­— (8-13)
          const ops = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 8); // 8-13
          // éš¨æ©Ÿé¸æ“‡é‹ç®—æ–¹å¼
          const sum = ops.reduce((a, b) => a + b, 0);
          const target = Math.max(10, Math.min(13, sum - Math.floor(Math.random() * 8)));
          return { ops, target };
        }
      },
      
      // æ¨¡å¼ 5: æ··åˆé‹ç®—ï¼ˆå¤§æ•¸å­— + å°æ•¸å­—ï¼‰- ğŸ”¥ å°æ•¸å­—æ”¹ç‚º 1-7
      {
        name: 'mixed_big_small',
        generate: () => {
          const big1 = Math.floor(Math.random() * 6) + 8; // 8-13 (å¤§æ•¸å­—)
          const big2 = Math.floor(Math.random() * 6) + 8; // 8-13 (å¤§æ•¸å­—)
          const small1 = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const small2 = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const small3 = 1;
          // (big1 - small1) + (big2 - small2) - small3
          const target = (big1 - small1) + (big2 - small2) - small3;
          // ç¢ºä¿ç›®æ¨™å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
          if (target < 3 || target > 13) {
            throw new Error('Invalid target');
          }
          const ops = [big1, big2, small1, small2, small3].sort(() => Math.random() - 0.5);
          return { ops, target };
        }
      },
      
      // æ¨¡å¼ 6: ä¹˜é™¤æ··åˆï¼ˆå¤§æ•¸å­—æŒ‘æˆ°ï¼‰- ğŸ”¥ å°æ•¸å­—æ”¹ç‚º 1-7
      {
        name: 'multiply_divide_big',
        generate: () => {
          const factor1 = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const factor2 = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const product = factor1 * factor2; // 1-49
          const divisor = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const dividend = product * divisor; // 1-343ï¼Œä½†é™åˆ¶åœ¨ 13 ä»¥å…§
          if (dividend > 13) {
            throw new Error('Invalid puzzle');
          }
          const small1 = Math.floor(Math.random() * 7) + 1; // 1-7 (å°æ•¸å­—)
          const small2 = 1;
          const target = product + small1 + small2;
          // ç¢ºä¿ç›®æ¨™å€¼åœ¨æœ‰æ•ˆç¯„åœå…§
          if (target < 3 || target > 13) {
            throw new Error('Invalid target');
          }
          const ops = [dividend, divisor, factor1, small1, small2].sort(() => Math.random() - 0.5);
          return { ops, target };
        }
      }
    ];

    // ç”Ÿæˆå–®ä¸€æœ‰æ•ˆé¡Œç›®ï¼ˆ6 ç¨®æ¨¡å¼è¼ªæµï¼‰
    function generateUniquePuzzle() {
      let attempts = 0;
      const maxAttempts = 100; // å¢åŠ å˜—è©¦æ¬¡æ•¸
      
      while (attempts < maxAttempts) {
        // éš¨æ©Ÿé¸æ“‡æ¨¡å¼ï¼ˆä½†é¿å…é€£çºŒç›¸åŒï¼‰
        let patternIndex;
        do {
          patternIndex = Math.floor(Math.random() * SOLUTION_PATTERNS.length);
        } while (patternIndex === lastUsedPattern && SOLUTION_PATTERNS.length > 1);
        
        lastUsedPattern = patternIndex;
        const pattern = SOLUTION_PATTERNS[patternIndex];
        
        try {
          const puzzle = pattern.generate();
          
          // é©—è­‰é¡Œç›®æœ‰æ•ˆæ€§
          if (isValidPuzzle(puzzle)) {
            const signature = getPuzzleSignature(puzzle);
            
            // ç¢ºä¿ä¸é‡è¤‡
            if (!generatedPuzzles.has(signature)) {
              // å¦‚æœæ˜¯å¤§æ•¸å­—æ¨¡å¼ï¼Œå¢åŠ è¨˜éŒ„é »ç‡
              if (pattern.name.includes('big')) {
                console.log('ğŸ¯ ç”Ÿæˆå¤§æ•¸å­—é¡Œç›®:', puzzle);
              }
              generatedPuzzles.add(signature);
              return puzzle;
            }
          }
        } catch (e) {
          // å¿½ç•¥ç„¡æ•ˆé¡Œç›®ï¼Œç¹¼çºŒå˜—è©¦
        }
        
        attempts++;
      }
      
      // å¦‚æœéƒ½å¤±æ•—ï¼Œå›é€€åˆ°ç°¡å–®é¡Œç›®
      return generateFallbackPuzzle();
    }

    // é©—è­‰é¡Œç›®æ˜¯å¦æœ‰æ•ˆï¼ˆæ”¯æ´å¤§æ•¸å­—ï¼‰
    function isValidPuzzle(puzzle) {
      // æª¢æŸ¥æ•¸å­—ç¯„åœ (1-13)
      if (!puzzle.ops.every(x => x >= 1 && x <= 13)) return false;
      
      // æª¢æŸ¥ç›®æ¨™å€¼ç¯„åœ (3-13)
      if (puzzle.target < 3 || puzzle.target > 13) return false;
      
      // æª¢æŸ¥åŸºæœ¬å¯è§£æ€§
      const sum = puzzle.ops.reduce((a, b) => a + b, 0);
      const minPossible = Math.max(1, puzzle.ops.reduce((a, b) => Math.min(a, b), 13));
      
      if (sum < puzzle.target) return false;
      if (minPossible > puzzle.target && puzzle.ops.length > 1) return false;
      
      return true;
    }

    // å›é€€é¡Œç›®ç”Ÿæˆï¼ˆåŒ…å«å¤§æ•¸å­—æ©Ÿæœƒï¼‰
    function generateFallbackPuzzle() {
      // 30% æ©Ÿæœƒç”Ÿæˆå¤§æ•¸å­—é¡Œç›®
      if (Math.random() < 0.3) {
        const ops = Array.from({length: 5}, () => Math.floor(Math.random() * 6) + 8); // 8-13
        const sum = ops.reduce((a, b) => a + b, 0);
        const target = Math.max(10, Math.min(13, sum - Math.floor(Math.random() * 8)));
        return { ops, target };
      } else {
        // ğŸ”¥ å°æ•¸å­—æ”¹ç‚º 1-7
        const ops = Array.from({length: 5}, () => Math.floor(Math.random() * 7) + 1); // 1-7
        const sum = ops.reduce((a, b) => a + b, 0);
        const target = Math.max(3, Math.min(13, sum - Math.floor(Math.random() * 4)));
        return { ops, target };
      }
    }

    // ç²å–é¡Œç›®ç°½åï¼ˆç”¨æ–¼å»é‡ï¼‰
    function getPuzzleSignature(puzzle) {
      const sortedOps = [...puzzle.ops].sort((a, b) => a - b);
      return sortedOps.join(',') + '|' + puzzle.target;
    }

    // === å·¥å…·å‡½æ•¸ ===
    function getRandomSuit() {
      return SUITS[Math.floor(Math.random() * SUITS.length)];
    }

    function valueToDisplay(value) {
      if (value >= 1 && value <= 13) {
        return VALUE_TO_RANK[value] + getRandomSuit();
      }
      return String(Math.round(value * 100) / 100);
    }

    function createCard(value, isNew = false) {
      const card = document.createElement('div');
      card.className = 'card';
      if (isNew) card.classList.add('new-glow');
      card.textContent = valueToDisplay(value);
      card.dataset.value = value;
      card.id = 'card-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      card.onclick = (e) => {
        e.stopPropagation();
        selectCard(card);
      };
      return card;
    }

    // === èªéŸ³ç³»çµ± ===
    function speakText(text) {
      // å„ªå…ˆä½¿ç”¨ Web Speech API
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.2;
        utterance.pitch = 1.0;
        speechSynthesis.speak(utterance);
        return true;
      }
      
      // å›é€€åˆ° Web Audio API
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // "Ready?" - é«˜éŸ³
        const oscillator1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        oscillator1.type = 'sine';
        oscillator1.frequency.value = 880;
        gain1.gain.value = 0.3;
        oscillator1.connect(gain1);
        gain1.connect(ctx.destination);
        oscillator1.start();
        oscillator1.stop(ctx.currentTime + 0.3);
        
        // "Go!" - ä½éŸ³
        setTimeout(() => {
          const oscillator2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          oscillator2.type = 'square';
          oscillator2.frequency.value = 440;
          gain2.gain.value = 0.4;
          oscillator2.connect(gain2);
          gain2.connect(ctx.destination);
          oscillator2.start();
          oscillator2.stop(ctx.currentTime + 0.4);
        }, 400);
        
        return true;
      } catch (e) {
        console.log("Audio not supported");
        return false;
      }
    }

    // === è¨ˆæ™‚ç³»çµ±ï¼ˆå«å€’æ•¸éŸ³æ•ˆï¼‰===
    function startTimer() {
      // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
      if (timer) clearInterval(timer);
      
      // é‡ç½®è¨ˆæ™‚ç‹€æ…‹
      timeLeft = 60;
      isGameActive = true;
      updateTimerUI();
      
      // æ’­æ”¾é–‹å§‹éŸ³æ•ˆ
      playCountdownSound('start');
      
      // å•Ÿå‹•æ–°è¨ˆæ™‚å™¨
      timer = setInterval(() => {
        // ğŸ”¥ é—œéµå®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿éŠæˆ²ä»åœ¨é€²è¡Œä¸­
        if (!isGameActive || currentTarget === null) {
          clearInterval(timer);
          timer = null;
          return;
        }
        
        timeLeft--;
        updateTimerUI();
        
        // ğŸ”¥ å€’æ•¸éŸ³æ•ˆé‚è¼¯
        if (timeLeft > 10 && timeLeft % 10 === 0) {
          // æ¯ 10 ç§’æé†’ï¼ˆ50, 40, 30, 20ï¼‰
          playCountdownSound('ten');
        } else if (timeLeft <= 10 && timeLeft > 0) {
          // æœ€å¾Œ 10 ç§’æ¯ç§’æé†’
          playCountdownSound('count', timeLeft);
        }
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          timer = null;
          isGameActive = false;
          // æ™‚é–“åˆ°éŸ³æ•ˆ
          playCountdownSound('end');
          // ğŸ”¥ åªæœ‰åœ¨æœ‰æ•ˆéŠæˆ²ç‹€æ…‹ä¸‹æ‰é¡¯ç¤ºå¤±æ•—ç•«é¢
          if (currentTarget !== null && originalHand.length > 0 && isGameActive === false) {
            setTimeout(showFailureScreen, 500);
          }
        }
      }, 1000);
    }

    // === å€’æ•¸éŸ³æ•ˆç³»çµ± ===
    function playCountdownSound(type, count = null) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        switch(type) {
          case 'start':
            // é–‹å§‹éŠæˆ²éŸ³æ•ˆ - ä¸Šå‡éŸ³éš
            createTone(ctx, 523, 0.2, 0); // C5
            createTone(ctx, 659, 0.2, 0.2); // E5
            createTone(ctx, 784, 0.3, 0.4); // G5
            break;
            
          case 'ten':
            // æ¯ 10 ç§’æé†’ - ä¸­é »æç¤ºéŸ³
            createTone(ctx, 880, 0.3, 0); // A5
            break;
            
          case 'count':
            // æœ€å¾Œ 10 ç§’å€’æ•¸ - ä¸åŒéŸ³é«˜
            const frequencies = [880, 831, 784, 740, 698, 659, 622, 587, 554, 523];
            const freq = frequencies[10 - count] || 523;
            createTone(ctx, freq, 0.2, 0);
            break;
            
          case 'end':
            // æ™‚é–“åˆ° - è­¦å‘ŠéŸ³
            createTone(ctx, 220, 0.4, 0); // A3
            createTone(ctx, 196, 0.4, 0.2); // G3
            break;
        }
      } catch (e) {
        console.log("Countdown sound not supported");
      }
    }

    // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºå–®ä¸€éŸ³èª¿
    function createTone(ctx, frequency, duration, startTime) {
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();
      
      oscillator.type = 'sine';
      oscillator.frequency.value = frequency;
      gainNode.gain.value = 0.3;
      
      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);
      
      const actualStartTime = ctx.currentTime + startTime;
      oscillator.start(actualStartTime);
      oscillator.stop(actualStartTime + duration);
    }

    // === è¨ˆæ™‚ UI æ›´æ–° ===
    function updateTimerUI() {
      const timeElement = document.getElementById('timeLeft');
      if (timeElement) {
        timeElement.textContent = timeLeft;
      }
      
      const fill = document.getElementById('timerFill');
      if (fill) {
        const percent = Math.max(0, timeLeft / 60 * 100);
        fill.style.width = percent + '%';
        if (timeLeft <= 18) {
          fill.style.background = '#d63031';
        } else {
          fill.style.background = '#0984e3';
        }
      }
    }

    // === è¨ˆåˆ†ç³»çµ± ===
    function addScore(base, timeBonus = 0, isCombo = false) {
      let total = base + timeBonus;
      if (isCombo && combo > 1) {
        total = Math.floor(total * (1 + (combo - 1) * 0.2));
      }
      score += total;
      document.getElementById('score').textContent = score;
    }

    // === æ ¸å¿ƒé‚è¼¯ ===
    function selectCard(card) {
      if (!isGameActive) return;
      
      if (selectedOperator !== null) {
        if (card === selectedCard1) {
          showMessage('ä¸èƒ½èˆ‡è‡ªå·±é‹ç®—ï¼', 'error');
          return;
        }
        performCalculation(card);
        return;
      }

      if (selectedCard1 === null) {
        selectedCard1 = card;
        card.classList.add('selected-first');
        document.getElementById('operatorMenu').style.display = 'flex';
        showMessage('å·²é¸æ“‡ç¬¬ä¸€å¼µå¡ï¼Œè«‹é¸æ“‡é‹ç®—ç¬¦', 'info');
        return;
      }

      if (card === selectedCard1) {
        clearSelection();
        showMessage('å·²å–æ¶ˆé¸æ“‡', 'info');
        return;
      }

      showMessage('è«‹å…ˆé¸æ“‡é‹ç®—ç¬¦ï¼', 'error');
    }

    function selectOperator(op) {
      if (selectedCard1 === null || !isGameActive) {
        showMessage('è«‹å…ˆé¸æ“‡ç¬¬ä¸€å¼µå¡ï¼', 'error');
        return;
      }
      selectedOperator = op;
      showMessage('å·²é¸æ“‡ "' + op + '"ï¼Œè«‹é»æ“Šç¬¬äºŒå¼µå¡', 'info');
    }

    function performCalculation(secondCard) {
      const val1 = parseFloat(selectedCard1.dataset.value);
      const val2 = parseFloat(secondCard.dataset.value);
      let result;

      switch(selectedOperator) {
        case '+': 
          result = val1 + val2; 
          break;
        case 'âˆ’': 
          // ğŸ”¥ æ–°å¢ï¼šæª¢æŸ¥ç›¸æ¸›æ˜¯å¦ç‚º0
          if (Math.abs(val1 - val2) < 1e-9) {
            showMessage('âŒ ä¸èƒ½å°‡å…©å¼µç›¸åŒæ•¸å€¼çš„å¡ç‰Œç›¸æ¸›ï¼', 'error');
            clearSelection();
            return;
          }
          result = val1 - val2; 
          break;
        case 'Ã—': 
          result = val1 * val2; 
          break;
        case 'Ã·':
          if (Math.abs(val2) < 1e-9) {
            showMessage('âŒ ä¸èƒ½é™¤ä»¥é›¶ï¼', 'error');
            clearSelection();
            return;
          }
          if (Math.abs(val1 % val2) > 1e-9) {
            showMessage('âŒ é™¤æ³•çµæœå¿…é ˆç‚ºæ•´æ•¸ï¼', 'error');
            clearSelection();
            return;
          }
          result = val1 / val2;
          break;
        default:
          clearSelection();
          return;
      }

      if (result < 0) {
        showMessage('âŒ çµæœä¸èƒ½ç‚ºè² æ•¸ï¼', 'error');
        clearSelection();
        return;
      }

      // ç§»é™¤å¡ç‰Œ
      selectedCard1.remove();
      secondCard.remove();

      // æ–°å¢çµæœå¡
      const newCard = createCard(result, true);
      document.getElementById('handArea').appendChild(newCard);

      clearSelection();

      // ğŸ”¥ å¢åŠ æ­¥é©Ÿè¨ˆæ•¸
      currentStep++;

      // æª¢æŸ¥æ˜¯å¦å®Œæˆ
      const remainingCards = document.querySelectorAll('.card');
      if (remainingCards.length === 1) {
        const finalValue = parseFloat(remainingCards[0].dataset.value);
        if (Math.abs(finalValue - currentTarget) < 1e-6) {
          const timeBonus = timeLeft * 10;
          combo++;
          addScore(100, timeBonus, true);
          clearInterval(timer);
          timer = null;
          isGameActive = false;
          // é¡¯ç¤ºæˆåŠŸç•«é¢
          setTimeout(showSuccessScreen, 500);
        } else {
          combo = 0;
          clearInterval(timer);
          timer = null;
          isGameActive = false;
          // é¡¯ç¤ºå¤±æ•—ç•«é¢
          setTimeout(showFailureScreen, 500);
        }
      }
    }

    function cancelSelection() {
      clearSelection();
      showMessage('å·²å–æ¶ˆé¸æ“‡', 'info');
    }

    function clearSelection() {
      if (selectedCard1) {
        selectedCard1.classList.remove('selected-first');
        selectedCard1 = null;
      }
      selectedOperator = null;
      document.getElementById('operatorMenu').style.display = 'none';
    }

    function resetHand() {
      if (!isGameActive) return;
      clearSelection();
      const handArea = document.getElementById('handArea');
      handArea.innerHTML = '';
      for (let i = 0; i < originalHand.length; i++) {
        handArea.appendChild(createCard(originalHand[i]));
      }
      // ğŸ”¥ é‡ç½®æ­¥é©Ÿ
      currentStep = 0;
      startTimer();
      showMessage('å·²é‡è¨­æ‰‹ç‰Œ', 'info');
    }

    function showHint() {
      // ğŸ”¥ é¡¯ç¤ºé€šç”¨ç­–ç•¥æç¤º
      const hint = getHintForStep(currentStep + 1);
      showMessage(`ğŸ’¡ ${hint}`, 'info');
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + type;
    }

    // ğŸ”¥ æ–°å¢ï¼šæ ¹æ“šæ­¥é©Ÿæä¾›é€šç”¨ç­–ç•¥æç¤º
    function getHintForStep(step) {
      const cards = Array.from(document.querySelectorAll('.card')).map(card => 
        parseFloat(card.dataset.value)
      );
      
      if (cards.length === 0) return 'è«‹å…ˆé¸æ“‡å¡ç‰Œ';
      
      // æ’åºå¡ç‰‡ï¼ˆå°åˆ°å¤§ï¼‰
      const sortedCards = [...cards].sort((a, b) => a - b);
      const target = currentTarget;
      
      switch(step) {
        case 1:
          // ç¬¬ä¸€æ­¥ï¼šå»ºè­°åˆä½µå°æ•¸å­—æˆ–è£½é€ å› æ•¸
          if (sortedCards.includes(1)) {
            return 'æœ‰1çš„è©±ï¼Œå…ˆç”¨1å’Œå…¶ä»–æ•¸å­—ç›¸åŠ ';
          }
          // ğŸ”¥ ä¿®æ”¹ï¼šå°æ•¸å­—å®šç¾©ç‚º 1-7
          if (sortedCards.some(x => x <= 7)) {
            return 'å…ˆåˆä½µå…©å€‹å°æ•¸å­—ï¼ˆâ‰¤7ï¼‰';
          }
          if (sortedCards.some(x => x >= 10)) {
            return 'æœ‰å¤§æ•¸å­—ï¼ˆâ‰¥10ï¼‰æ™‚ï¼Œè€ƒæ…®ç”¨æ¸›æ³•æˆ–é™¤æ³•';
          }
          return 'å°‹æ‰¾å¯ä»¥æ•´é™¤çš„æ•¸å­—å°';
          
        case 2:
          // ç¬¬äºŒæ­¥ï¼šæ ¹æ“šå‰©é¤˜å¡ç‰‡å»ºè­°
          if (sortedCards.some(x => x > 10)) {
            return 'å¤§æ•¸å­—ï¼ˆ>10ï¼‰å»ºè­°ç”¨æ¸›æ³•æˆ–é™¤æ³•';
          }
          if (sortedCards.some(x => x === 1)) {
            return '1å¯ä»¥ç”¨ä¾†å¾®èª¿çµæœ';
          }
          // ğŸ”¥ ä¿®æ”¹ï¼šå°æ•¸å­—å®šç¾©ç‚º 1-7
          if (sortedCards.some(x => x <= 7)) {
            return 'å°æ•¸å­—ï¼ˆâ‰¤7ï¼‰é©åˆç”¨ä¾†èª¿æ•´çµæœ';
          }
          if (target && sortedCards.some(x => target % x === 0)) {
            return 'å°‹æ‰¾ç›®æ¨™å€¼çš„å› æ•¸';
          }
          return 'å˜—è©¦è£½é€ ç›®æ¨™å€¼çš„å› æ•¸';
          
        case 3:
          // ç¬¬ä¸‰æ­¥ï¼šæ¥è¿‘å®Œæˆï¼Œå»ºè­°ç²¾ç¢ºè¨ˆç®—
          if (target && sortedCards.length >= 2) {
            const sum = sortedCards.reduce((a, b) => a + b, 0);
            if (sum === target) {
              return 'æ‰€æœ‰æ•¸å­—ç›¸åŠ ç­‰æ–¼ç›®æ¨™ï¼';
            }
            if (Math.abs(sum - target) <= 2) {
              return 'ç¸½å’Œæ¥è¿‘ç›®æ¨™ï¼Œèª¿æ•´é‹ç®—ç¬¦';
            }
            // ğŸ”¥ ä¿®æ”¹ï¼šè€ƒæ…®å°æ•¸å­—çš„å½±éŸ¿
            if (sortedCards.some(x => x <= 7 && (target - x >= 0))) {
              return 'ç”¨å°æ•¸å­—ï¼ˆâ‰¤7ï¼‰ä¾†å¾®èª¿çµæœ';
            }
            if (sortedCards.some(x => x * 2 === target || x * 3 === target)) {
              return 'æœ‰æ•¸å­—æ˜¯ç›®æ¨™å€¼çš„ä¸€åŠæˆ–ä¸‰åˆ†ä¹‹ä¸€';
            }
          }
          return 'æª¢æŸ¥æ˜¯å¦èƒ½ç”¨ä¹˜æ³•å¿«é€Ÿæ¥è¿‘ç›®æ¨™';
          
        case 4:
          // æœ€å¾Œä¸€æ­¥ï¼šåªå‰©å…©å¼µå¡
          if (sortedCards.length === 2) {
            const [a, b] = sortedCards;
            const target = currentTarget;
            if (target) {
              if (a + b === target) return 'ç”¨åŠ æ³•ï¼';
              if (Math.abs(a - b) === target) return 'ç”¨æ¸›æ³•ï¼';
              if (a * b === target) return 'ç”¨ä¹˜æ³•ï¼';
              if (b !== 0 && a % b === 0 && a / b === target) return 'ç”¨é™¤æ³•ï¼';
              if (a !== 0 && b % a === 0 && b / a === target) return 'ç”¨é™¤æ³•ï¼ˆäº¤æ›é †åºï¼‰ï¼';
            }
            return 'åªå‰©å…©å¼µå¡ï¼Œè©¦è©¦æ‰€æœ‰é‹ç®—ç¬¦ï¼';
          }
          return 'é€™æ˜¯æœ€å¾Œä¸€æ­¥ï¼Œä»”ç´°è¨ˆç®—ï¼';
          
        default:
          return 'æ­£å¸¸é€²è¡ŒéŠæˆ²';
      }
    }

    // === æˆåŠŸ/å¤±æ•—éŸ³æ•ˆå’Œè¨Šæ¯ ===

    // æˆåŠŸè´Šç¾èªå¥
    const SUCCESS_MESSAGES = [
      "ä½ çœŸæ˜¯æ•¸å­¸å¤©æ‰ï¼",
      "å¤ªç¥äº†ï¼å®Œå…¨æ­£ç¢ºï¼",
      "å®Œç¾è¨ˆç®—ï¼ç„¡å¯æŒ‘å‰”ï¼",
      "æ•¸å­¸å°é”äººå°±æ˜¯ä½ ï¼",
      "ç²¾æº–ç„¡èª¤ï¼å¤ªå²å®³äº†ï¼",
      "è¨ˆç®—è¶…ç´šæº–ç¢ºï¼",
      "ä½ è®“æ•¸å­¸è®Šå¾—è¶…ç°¡å–®ï¼",
      "å®Œç¾è§£é¡Œï¼çœŸæ£’ï¼"
    ];

    // å¤±æ•—é¼“å‹µèªå¥
    const FAILURE_MESSAGES = [
      "æ²’é—œä¿‚ï¼Œå†è©¦ä¸€æ¬¡ï¼",
      "å·®ä¸€é»å°±æˆåŠŸäº†ï¼",
      "ç¹¼çºŒåŠ æ²¹ï¼Œä½ å¾ˆæ£’ï¼",
      "ä¸è¦æ”¾æ£„ï¼Œä¸‹æ¬¡ä¸€å®šè¡Œï¼",
      "å­¸ç¿’å°±æ˜¯ä¸æ–·å˜—è©¦ï¼",
      "ä½ å·²ç¶“å¾ˆæ¥è¿‘äº†ï¼",
      "æ¯å€‹éŒ¯èª¤éƒ½æ˜¯é€²æ­¥çš„æ©Ÿæœƒï¼",
      "ç›¸ä¿¡è‡ªå·±ï¼Œä½ å¯ä»¥çš„ï¼"
    ];

    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
    function playSuccessSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // æ­¡å¿«ä¸Šå‡éŸ³éš
        createTone(ctx, 523, 0.15, 0);   // C5
        createTone(ctx, 659, 0.15, 0.15); // E5  
        createTone(ctx, 784, 0.15, 0.3);  // G5
        createTone(ctx, 1046, 0.2, 0.45); // C6
      } catch (e) {
        console.log("Success sound not supported");
      }
    }

    // æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
    function playFailureSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // æº«å’Œä¸‹é™éŸ³éš
        createTone(ctx, 523, 0.2, 0);     // C5
        createTone(ctx, 440, 0.2, 0.2);   // A4
        createTone(ctx, 392, 0.25, 0.4);  // G4
      } catch (e) {
        console.log("Failure sound not supported");
      }
    }

    // é¡¯ç¤ºæˆåŠŸç•«é¢
    function showSuccessScreen() {
      playSuccessSound();
      
      // è¨ˆç®—ä½¿ç”¨æ™‚é–“
      const usedTime = 60 - timeLeft;
      document.getElementById('successTimeMessage').textContent = `ğŸ‰ ä½ èŠ±äº† ${usedTime} ç§’å®Œæˆï¼`;
      
      const randomMessage = SUCCESS_MESSAGES[Math.floor(Math.random() * SUCCESS_MESSAGES.length)];
      document.getElementById('successMessage').textContent = randomMessage;
      document.getElementById('successModal').style.display = 'flex';
      
      // ğŸ”¥ æ›´æ–°å¿«ç…§ï¼ˆä¿ç•™æœ€å¾Œç‹€æ…‹ï¼‰
      if (currentGameSnapshot) {
        currentGameSnapshot.score = score;
        currentGameSnapshot.timeLeft = timeLeft;
      }
    }

    // é¡¯ç¤ºå¤±æ•—ç•«é¢  
    function showFailureScreen() {
      playFailureSound();
      
      const randomMessage = FAILURE_MESSAGES[Math.floor(Math.random() * FAILURE_MESSAGES.length)];
      document.getElementById('failureMessage').textContent = randomMessage;
      document.getElementById('failureModal').style.display = 'flex';
      
      // ğŸ”¥ æ›´æ–°å¿«ç…§ï¼ˆä¿ç•™æœ€å¾Œç‹€æ…‹ï¼‰
      if (currentGameSnapshot) {
        currentGameSnapshot.score = score;
        currentGameSnapshot.timeLeft = timeLeft;
      }
    }

    // ç¹¼çºŒæŒ‘æˆ°
    function continueChallenge() {
      // æ¸…é™¤ä»»ä½•ç¾æœ‰çš„è¨ˆæ™‚å™¨
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      
      // éš±è—å½ˆå‡ºç•«é¢
      document.getElementById('successModal').style.display = 'none';
      document.getElementById('failureModal').style.display = 'none';
      
      // é‡ç½®éŠæˆ²ç‹€æ…‹
      currentTarget = null;
      originalHand = [];
      score = 0;
      combo = 0;
      currentStep = 0;
      isGameActive = false;
      timeLeft = 60;
      
      document.getElementById('score').textContent = '0';
      document.getElementById('timeLeft').textContent = '60';
      document.getElementById('message').textContent = 'ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼';
      document.getElementById('message').className = 'message info';
      
      // æ¸…ç©ºæ‰‹ç‰Œå€åŸŸ
      document.getElementById('handArea').innerHTML = '';
      document.getElementById('targetCard').textContent = '?';
      
      // ğŸ”¥ ç›´æ¥é–‹å§‹æ–°éŠæˆ²ï¼ˆä¸é¡¯ç¤º Start! æŒ‰éˆ•ï¼‰
      setTimeout(() => {
        loadNewGame();
        startTimer();
      }, 500);
    }

    // é‡æ–°é–‹å§‹éŠæˆ²ï¼ˆé‡æ–°é–‹å§‹å‰›æ‰çš„åŒä¸€å±€ï¼‰
    function restartGame() {
      // æ¸…é™¤è¨ˆæ™‚å™¨
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      
      // éš±è—å½ˆå‡ºç•«é¢
      document.getElementById('successModal').style.display = 'none';
      document.getElementById('failureModal').style.display = 'none';
      
      // ğŸ”¥ å¦‚æœæœ‰éŠæˆ²å¿«ç…§ï¼Œé‡æ–°è¼‰å…¥åŒä¸€å±€
      if (currentGameSnapshot) {
        currentTarget = currentGameSnapshot.target;
        originalHand = [...currentGameSnapshot.hand];
        score = currentGameSnapshot.score;
        timeLeft = currentGameSnapshot.timeLeft;
      } else {
        // å¦‚æœæ²’æœ‰å¿«ç…§ï¼Œå›åˆ° Start! é é¢
        currentTarget = null;
        originalHand = [];
        score = 0;
        timeLeft = 60;
      }
      
      isGameActive = false;
      currentStep = 0;
      combo = 0;
      
      // æ›´æ–° UI
      document.getElementById('score').textContent = score;
      document.getElementById('timeLeft').textContent = timeLeft;
      document.getElementById('targetCard').textContent = valueToDisplay(currentTarget);
      document.getElementById('message').textContent = 'ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼';
      document.getElementById('message').className = 'message info';
      
      // é‡æ–°è¼‰å…¥æ‰‹ç‰Œ
      const handArea = document.getElementById('handArea');
      handArea.innerHTML = '';
      for (let i = 0; i < originalHand.length; i++) {
        handArea.appendChild(createCard(originalHand[i]));
      }
      
      // å¦‚æœæœ‰æœ‰æ•ˆéŠæˆ²ï¼Œç›´æ¥é–‹å§‹è¨ˆæ™‚
      if (currentTarget !== null) {
        setTimeout(() => {
          startTimer();
        }, 100);
      } else {
        // å›åˆ° Start! é é¢
        const overlay = document.getElementById('startOverlay');
        overlay.style.display = 'block';
        overlay.classList.add('blur');
        overlay.classList.add('active');
        
        setTimeout(() => {
          positionStartButton();
        }, 100);
      }
    }

    // === é¡Œç›®ç®¡ç† ===
    function loadNewGame() {
      combo = 0;
      currentStep = 0;
      
      // ç”Ÿæˆå…¨æ–°é¡Œç›®ï¼ˆç„¡é™ä¸é‡è¤‡ï¼‰
      const p = generateUniquePuzzle();
      
      currentTarget = p.target;
      originalHand = [...p.ops];
      document.getElementById('targetCard').textContent = valueToDisplay(currentTarget);

      const handArea = document.getElementById('handArea');
      handArea.innerHTML = '';
      for (let i = 0; i < p.ops.length; i++) {
        handArea.appendChild(createCard(p.ops[i]));
      }

      clearSelection();
      showMessage('ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼', 'info');
      
      // ğŸ”¥ å„²å­˜ç•¶å‰éŠæˆ²å¿«ç…§
      currentGameSnapshot = {
        target: currentTarget,
        hand: [...originalHand],
        score: score,
        timeLeft: timeLeft
      };
    }

    // === å‹•æ…‹å®šä½ Start! æŒ‰éˆ• ===
    function positionStartButton() {
      const handArea = document.querySelector('.hand-area');
      if (!handArea) return;
      
      const rect = handArea.getBoundingClientRect();
      const overlayContent = document.querySelector('.start-overlay-content');
      
      if (overlayContent) {
        // è¨­å®šæŒ‰éˆ•ä½ç½®åˆ°æ‰‹ç‰Œå€åŸŸä¸­å¿ƒ
        overlayContent.style.left = rect.left + rect.width / 2 + 'px';
        overlayContent.style.top = rect.top + rect.height / 2 + window.scrollY + 'px';
        overlayContent.style.transform = 'translate(-50%, -50%)';
      }
    }

    // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°å®šä½
    window.addEventListener('resize', () => {
      if (document.getElementById('startOverlay').classList.contains('active')) {
        setTimeout(positionStartButton, 100);
      }
    });

    // === é–‹å§‹éŠæˆ²æµç¨‹ï¼ˆæ‰‹ç‰Œå€åŸŸæŒ‰éˆ•ï¼‰===
    function startGame() {
      // æ’­æ”¾èªéŸ³
      speakText("Ready? Go!");
      
      // è¼‰å…¥æ–°éŠæˆ²ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
      loadNewGame();
      
      // é–‹å§‹è¨ˆæ™‚
      startTimer();
      
      // ç§»é™¤æ¨¡ç³Šæ•ˆæœå’Œè¦†è“‹å±¤
      const overlay = document.getElementById('startOverlay');
      overlay.classList.remove('blur');
      overlay.classList.remove('active');
      
      // éš±è—æŒ‰éˆ•
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 500);
    }

    function newGame() {
      loadNewGame();
      startTimer();
    }

    // === Modal ===
    function openInstructions() {
      document.getElementById('instructionsModal').style.display = 'block';
    }
    function closeInstructions() {
      document.getElementById('instructionsModal').style.display = 'none';
    }
    window.onclick = function(event) {
      const modal = document.getElementById('instructionsModal');
      if (event.target === modal) closeInstructions();
    };

    // === å•Ÿå‹•éŠæˆ² ===
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… æ™ºèƒ½é¡Œåº«ç³»çµ±å•Ÿå‹•ï¼ˆ6ç¨®ä¸åŒè§£æ³• + å¤§æ•¸å­—å„ªåŒ–ï¼‰');
      
      // åˆå§‹ç‹€æ…‹è®Šæ•¸
      currentTarget = null;
      originalHand = [];
      score = 0;
      combo = 0;
      currentStep = 0;
      isGameActive = false;
      timeLeft = 60;
      timer = null;
      currentGameSnapshot = null;
      
      // åˆå§‹ UI ç‹€æ…‹
      document.getElementById('score').textContent = '0';
      document.getElementById('timeLeft').textContent = '60';
      document.getElementById('targetCard').textContent = '?';
      document.getElementById('handArea').innerHTML = '';
      document.getElementById('message').textContent = 'ğŸ¯ é»æ“Š "Start!" é–‹å§‹éŠæˆ²';
      
      // ç¢ºä¿å½ˆå‡ºç•«é¢éš±è—
      document.getElementById('successModal').style.display = 'none';
      document.getElementById('failureModal').style.display = 'none';
      
      // é¡¯ç¤ºæ¨¡ç³Šè¦†è“‹å±¤
      const overlay = document.getElementById('startOverlay');
      overlay.classList.add('active');
      
      // å®šä½æŒ‰éˆ•
      setTimeout(() => {
        positionStartButton();
      }, 100);
    });
  </script>
</body>
</html>
